#!/usr/bin/env bash
: 'unpack: Extract common file formats

Dependencies: unrar, unzip, p7zip-full

Author: Patrick Brisbin
From: http://linuxtidbits.wordpress.com/2009/08/04/week-of-bash-scripts-extract/
Modified by: José Martínez Santana'

# Default target directory
TARGET_DIR=$(pwd)

# Parse flags
while getopts "hd:" OPTION; do
    case $OPTION in
        h)
            echo "Usage: ${0##*/} [-d TARGET_DIR] <archive> [archive2 ...] - extract common file formats"
            echo "Supported formats: .7z, .tar.bz2, .bz2, .deb, .tar.gz, .gz, .tar, .tbz2, .tar.xz, .tgz, .rar, .zip, .Z"
            exit 0
            ;;
        d)
            TARGET_DIR="$OPTARG"
            ;;
        *)
            echo "Error: Invalid option"
            exit 1
            ;;
    esac
done

# Shift parsed options to process file arguments
shift $((OPTIND - 1))

# Validate target directory
if [ ! -d "$TARGET_DIR" ]; then
    echo "Error: Target directory '$TARGET_DIR' does not exist."
    exit 1
fi

# Required programs
req_progs=(7z unrar unzip)
missing_progs=()
for p in "${req_progs[@]}"; do
    if ! command -v "$p" &> /dev/null; then
        missing_progs+=("$p")
    fi
done

if [ "${#missing_progs[@]}" -gt 0 ]; then
    echo "Warning: The following programs are not installed: ${missing_progs[*]}"
    echo "Some formats may not be supported."
fi

# Process each file passed as an argument
for FILE in "$@"; do
    # Test if file exists
    if [ ! -f "$FILE" ]; then
        echo "Error: File '$FILE' does not exist."
        continue
    fi

    # Extract file by using extension as reference
    echo "Extracting '$FILE' to '$TARGET_DIR'..."
    case "$FILE" in
        *.7z ) 7z x "$FILE" -o"$TARGET_DIR" ;;
        *.tar.bz2 ) tar xvjf "$FILE" -C "$TARGET_DIR" ;;
        *.bz2 ) bunzip2 -c "$FILE" > "$TARGET_DIR/${FILE%.bz2}" ;;
        *.deb ) ar vx "$FILE" -C "$TARGET_DIR" ;;
        *.tar.gz ) tar xvf "$FILE" -C "$TARGET_DIR" ;;
        *.gz ) gunzip -c "$FILE" > "$TARGET_DIR/${FILE%.gz}" ;;
        *.tar ) tar xvf "$FILE" -C "$TARGET_DIR" ;;
        *.tbz2 ) tar xvjf "$FILE" -C "$TARGET_DIR" ;;
        *.tar.xz ) tar xvf "$FILE" -C "$TARGET_DIR" ;;
        *.tgz ) tar xvzf "$FILE" -C "$TARGET_DIR" ;;
        *.rar ) unrar x "$FILE" "$TARGET_DIR" ;;
        *.zip ) unzip "$FILE" -d "$TARGET_DIR" ;;
        *.Z ) uncompress -c "$FILE" > "$TARGET_DIR/${FILE%.Z}" ;;
        * ) echo "Unsupported file format: '$FILE'" ;;
    esac
    echo "Done extracting '$FILE'."
done