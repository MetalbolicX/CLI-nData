#!/usr/bin/env bash
set -eo pipefail

readonly PROGNAME="$(basename "$0")"
readonly PROGDIR="$(readlink -m "$(dirname "$0")")"
readonly UTILS_DIR="$PROGDIR/utils"
# readonly PYTHON_RUNNER="$UTILS_DIR/python-runner"

run_reloadserver() {
    # Ensure venv and dependencies are set up (without running a script)
    if [ ! -d "$UTILS_DIR/venv" ]; then
        python3 -m venv "$UTILS_DIR/venv" || { echo "Error: Failed to create virtual environment." >&2; exit 1; }
    fi
    source "$UTILS_DIR/venv/bin/activate" || { echo "Error: Failed to activate virtual environment." >&2; exit 1; }
    local requirements="$UTILS_DIR/requirements.txt"
    local install_marker="$UTILS_DIR/venv/.install_complete"
    if [ -f "$requirements" ] && [ "$requirements" -nt "$install_marker" ]; then
        pip install -r "$requirements" || { echo "Error: Failed to install dependencies." >&2; deactivate; exit 1; }
        touch "$install_marker"
    fi
    exec python3 -m reloadserver
}

main() {
    run_reloadserver
}

main "$@"
